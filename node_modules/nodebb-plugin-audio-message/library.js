'use strict';

const fs = require('fs/promises');
const path = require('path');
const cron = require('node-cron');
const meta = require.main.require('./src/meta');

const plugin = {};
let scheduledTask;

plugin.init = async function(params) {
    const { router, middleware } = params;
    
    console.log('[plugin/audio-message] Audio Message Plugin loaded and initialized.');

    // 安排一个任务，每小时执行一次，清理24小时前的音频文件
    // cron 表达式 '0 * * * *' 意思是 "在每小时的第0分钟"
    scheduledTask = cron.schedule('0 * * * *', async () => {
        console.log('[plugin/audio-message] Running scheduled job to delete old audio files...');
        
        try {
            const uploadPath = meta.configs.upload_path;
            if (!uploadPath) {
                console.warn('[plugin/audio-message] `upload_path` is not configured in NodeBB. Skipping deletion task.');
                return;
            }
            const files = await fs.readdir(uploadPath);

            const now = Date.now();
            const twentyFourHours = 24 * 60 * 60 * 1000; // 24小时的毫秒数

            for (const file of files) {
                // 只处理本插件上传的 'audio_' 前缀文件
                if (file.startsWith('audio_')) {
                    const filePath = path.join(uploadPath, file);
                    
                    try {
                        const stats = await fs.stat(filePath);
                        const fileAge = now - stats.birthtimeMs; // 文件创建时间

                        if (fileAge > twentyFourHours) {
                            await fs.unlink(filePath);
                            console.log(`[plugin/audio-message] Deleted expired audio file: ${file}`);
                        }
                    } catch (statErr) {
                        if (statErr.code !== 'ENOENT') { // 忽略文件已不存在的错误
                            console.error(`[plugin/audio-message] Could not process file ${file}:`, statErr);
                        }
                    }
                }
            }
        } catch (err) {
            console.error('[plugin/audio-message] Error during scheduled audio deletion job:', err);
        }
    }, {
        scheduled: true,
        timezone: "Asia/Shanghai" // 建议明确指定时区
    });

    console.log('[plugin/audio-message] Scheduled deletion task has been set up.');
};

plugin.parseAudioMessage = async function(data) {
    return data;
};

plugin.addAudioButton = async function(data) {
    return data;
};

// 插件停用或卸载时，停止定时任务
plugin.shutdown = async function() {
    if (scheduledTask) {
        scheduledTask.stop();
        console.log('[plugin/audio-message] Scheduled deletion task stopped.');
    }
};

module.exports = plugin;
