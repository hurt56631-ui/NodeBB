'use strict';

$(document).ready(function() {
    const AudioMessage = {
        mediaRecorder: null,
        audioChunks: [],
        isRecording: false,
        maxDuration: 60000, // 最大60秒
        recordingTimer: null,
        timeInterval: null,

        init: function() {
            this.addAudioButton();
            this.bindEvents();
        },

        // 添加录音按钮到编辑器
        addAudioButton: function() {
            const audioBtn = `
                <li class="audio-message-btn" tabindex="-1" component="audio-message-btn">
                    <a href="#" data-format="audio" title="发送语音消息">
                        <i class="fa fa-microphone"></i>
                    </a>
                </li>
            `;
            
            $(window).on('action:composer.loaded', function(ev, data) {
                const toolbar = $('[component="composer"] .formatting-bar .formatting-group[data-type="buttons"]');
                if (toolbar.length && !toolbar.find('[component="audio-message-btn"]').length) {
                    toolbar.append(audioBtn);
                }
            });
        },

        bindEvents: function() {
            const self = this;
            $(document).on('click', '[component="audio-message-btn"]', function(e) {
                e.preventDefault();
                if (self.isRecording) {
                    self.stopRecording();
                } else {
                    self.startRecording($(this));
                }
            });
        },

        // 开始录音
        startRecording: async function($btn) {
            const self = this;
            
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    audio: {
                        echoCancellation: true,
                        noiseSuppression: true,
                        sampleRate: 44100
                    }
                });

                this.audioChunks = [];
                this.mediaRecorder = new MediaRecorder(stream, {
                    mimeType: this.getSupportedMimeType()
                });

                this.mediaRecorder.ondataavailable = (event) => {
                    if (event.data.size > 0) {
                        self.audioChunks.push(event.data);
                    }
                };

                this.mediaRecorder.onstop = () => {
                    self.handleRecordingComplete();
                    stream.getTracks().forEach(track => track.stop());
                };

                this.mediaRecorder.start(100);
                this.isRecording = true;
                
                $btn.addClass('recording');
                $btn.find('i').removeClass('fa-microphone').addClass('fa-stop');
                this.showRecordingIndicator($btn);

                this.recordingTimer = setTimeout(() => {
                    self.stopRecording();
                }, this.maxDuration);

            } catch (err) {
                console.error('录音失败:', err);
                this.showError('无法访问麦克风，请检查权限设置');
            }
        },

        // 停止录音
        stopRecording: function() {
            if (this.mediaRecorder && this.isRecording) {
                this.mediaRecorder.stop();
                this.isRecording = false;
                
                clearTimeout(this.recordingTimer);
                
                const $btn = $('[component="audio-message-btn"]');
                $btn.removeClass('recording');
                $btn.find('i').removeClass('fa-stop').addClass('fa-microphone');
                this.hideRecordingIndicator();
            }
        },

        // 处理录音完成
        handleRecordingComplete: function() {
            const mimeType = this.getSupportedMimeType();
            const audioBlob = new Blob(this.audioChunks, { type: mimeType });
            
            if (audioBlob.size < 1000) {
                this.showError('录音时间太短');
                return;
            }

            this.uploadAudio(audioBlob);
        },

        // 上传音频
        uploadAudio: function(audioBlob) {
            const self = this;
            const formData = new FormData();
            const extension = this.getExtensionFromMime(audioBlob.type);
            const filename = `audio_${Date.now()}.${extension}`;
            
            formData.append('files[]', audioBlob, filename);

            this.showUploadProgress();

            $.ajax({
                url: config.relative_path + '/api/post/upload',
                type: 'POST',
                data: formData,
                processData: false,
                contentType: false,
                headers: {
                    'x-csrf-token': config.csrf_token
                },
                xhr: function() {
                    const xhr = new XMLHttpRequest();
                    xhr.upload.addEventListener('progress', function(e) {
                        if (e.lengthComputable) {
                            const percent = (e.loaded / e.total) * 100;
                            self.updateUploadProgress(percent);
                        }
                    });
                    return xhr;
                },
                success: function(response) {
                    self.hideUploadProgress();
                    if (response && response.files && response.files.length > 0) {
                        self.insertAudioTag(response.files[0].url);
                    }
                },
                error: function(xhr) {
                    self.hideUploadProgress();
                    self.showError('上传失败: ' + (xhr.responseJSON?.error || '未知错误'));
                }
            });
        },

        // 插入音频标签到编辑器
        insertAudioTag: function(url) {
            const audioMarkdown = `\n[audio:${url}]\n`;
            require(['composer/formatting'], function(formatting) {
                if (formatting && typeof formatting.appendToComposer === 'function') {
                    formatting.appendToComposer(audioMarkdown);
                }
            });
        },

        // 获取支持的 MIME 类型
        getSupportedMimeType: function() {
            const types = ['audio/webm;codecs=opus', 'audio/webm', 'audio/ogg;codecs=opus', 'audio/mp4', 'audio/mpeg'];
            for (const type of types) {
                if (MediaRecorder.isTypeSupported(type)) {
                    return type;
                }
            }
            return 'audio/webm';
        },

        getExtensionFromMime: function(mimeType) {
            const map = { 'audio/webm': 'webm', 'audio/ogg': 'ogg', 'audio/mp4': 'm4a', 'audio/mpeg': 'mp3' };
            return map[mimeType.split(';')[0]] || 'webm';
        },

        // UI 辅助方法
        showRecordingIndicator: function($btn) {
            const indicator = `
                <div class="audio-recording-indicator">
                    <span class="recording-dot"></span>
                    <span class="recording-time">00:00</span>
                    <span class="recording-text">录音中...</span>
                </div>
            `;
            $(indicator).insertAfter($('[component="composer"] .formatting-bar'));
            
            let seconds = 0;
            this.timeInterval = setInterval(() => {
                seconds++;
                const mins = Math.floor(seconds / 60).toString().padStart(2, '0');
                const secs = (seconds % 60).toString().padStart(2, '0');
                $('.recording-time').text(`${mins}:${secs}`);
            }, 1000);
        },

        hideRecordingIndicator: function() {
            clearInterval(this.timeInterval);
            $('.audio-recording-indicator').remove();
        },

        showUploadProgress: function() {
            const progress = `<div class="audio-upload-progress"><div class="progress"><div class="progress-bar" style="width: 0%"></div></div><span>上传中...</span></div>`;
            $('[component="composer"]').append(progress);
        },

        updateUploadProgress: function(percent) {
            $('.audio-upload-progress .progress-bar').css('width', percent + '%');
        },

        hideUploadProgress: function() {
            $('.audio-upload-progress').remove();
        },

        showError: function(message) {
            require(['alerts'], function(alerts) {
                alerts.error(message);
            });
        }
    };

    const AudioPlayer = {
        init: function() {
            $(window).on('action:posts.loaded action:topic.loaded', () => this.renderPlayers());
            this.renderPlayers();
        },

        renderPlayers: function() {
            $('[component="post/content"] .audio-player-placeholder').each(function() {
                const $placeholder = $(this);
                const url = $placeholder.data('src');
                if (!url) return;

                const playerHTML = `
                    <div class="audio-player" data-src="${url}">
                        <audio src="${url}" preload="metadata"></audio>
                        <button class="play-btn"><i class="fa fa-play"></i><i class="fa fa-pause"></i></button>
                        <div class="progress-container"><div class="progress-bar"></div></div>
                        <span class="duration">0:00</span>
                    </div>
                `;
                const $player = $(playerHTML);
                $placeholder.replaceWith($player);
                
                const audio = $player.find('audio')[0];

                audio.addEventListener('loadedmetadata', () => $player.find('.duration').text(AudioPlayer.formatTime(audio.duration)));
                audio.addEventListener('timeupdate', () => $player.find('.progress-bar').css('width', ((audio.currentTime / audio.duration) * 100) + '%'));
                audio.addEventListener('ended', () => $player.removeClass('playing'));
                
                $player.find('.play-btn').on('click', function() {
                    if (audio.paused) {
                        $('audio').each(function() { this.pause(); });
                        $('.audio-player').removeClass('playing');
                        audio.play();
                        $player.addClass('playing');
                    } else {
                        audio.pause();
                        $player.removeClass('playing');
                    }
                });
            });

            // 服务端预解析的转换
            $('[component="post/content"]:not(:has(.audio-player-placeholder))').each(function() {
                const $content = $(this);
                let html = $content.html();
                const audioRegex = /\[audio:(.*?)\]/g;
                if (audioRegex.test(html)) {
                    html = html.replace(audioRegex, (match, url) => `<div class="audio-player-placeholder" data-src="${url}"></div>`);
                    $content.html(html);
                    AudioPlayer.renderPlayers(); // 重新渲染
                }
            });
        },
        
        formatTime: function(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return `${mins}:${secs.toString().padStart(2, '0')}`;
        }
    };
    
    AudioMessage.init();
    AudioPlayer.init();
});
