"use strict";(self.webpackChunknodebb=self.webpackChunknodebb||[]).push([[40559],{28721:((M,j,c)=>{var S,E;S=[c(29930)],E=(function(w){var x={},P,b;x.init=function(d,g){var n=d.find(".tags");if(n.length){P=ajaxify.data.hasOwnProperty("minTags")?ajaxify.data.minTags:config.minimumTagsPerTopic,b=ajaxify.data.hasOwnProperty("maxTags")?ajaxify.data.maxTags:config.maximumTagsPerTopic,n.tagsinput({tagClass:"badge bg-info rounded-1",confirmKeys:[13,44],trimValue:!0});var a=d.find(".bootstrap-tagsinput input");f(d,g,ajaxify.data),app.loadJQueryUI(function(){a.autocomplete({delay:100,position:{my:"left bottom",at:"left top",collision:"flip"},appendTo:d.find(".bootstrap-tagsinput"),open:function(){$(this).autocomplete("widget").css("z-index",2e4)},source:function(r,l){socket.emit("topics.autocompleteTags",{query:r.term,cid:g.cid},function(T,s){if(T)return w.error(T);s&&l(s),$(".ui-autocomplete a").attr("data-ajaxify","false")})},select:function(){m(a)}}),R(g.tags,n),n.on("beforeItemAdd",function(r){var l=b&&b<=x.getTags(d.attr("data-uuid")).length,T=utils.cleanUpTag(r.item,config.maximumTagLength),s=T!==r.item;if(r.cancel=s||r.item.length<config.minimumTagLength||r.item.length>config.maximumTagLength||l,r.item.length<config.minimumTagLength)return w.error("[[error:tag-too-short, "+config.minimumTagLength+"]]");if(r.item.length>config.maximumTagLength)return w.error("[[error:tag-too-long, "+config.maximumTagLength+"]]");if(l)return w.error("[[error:too-many-tags, "+b+"]]");var v=g.hasOwnProperty("cid")?g.cid:ajaxify.data.cid;$(window).trigger("action:tag.beforeAdd",{cid:v,tagEl:n,tag:r.item,event:r,inputAutocomplete:a}),s&&n.tagsinput("add",T),r.cancel&&a.length&&a.autocomplete("close")}),n.on("itemRemoved",function(r){!r.item||r.options&&r.options.skipRemoveCheck||socket.emit("topics.canRemoveTag",{tag:r.item},function(l,T){if(l)return w.error(l);T||(w.error("[[error:cant-remove-system-tag]]"),n.tagsinput("add",r.item,{skipAddCheck:!0}))})}),n.on("itemAdded",function(r){if(!(r.options&&r.options.skipAddCheck)){var l=g.hasOwnProperty("cid")?g.cid:ajaxify.data.cid;socket.emit("topics.isTagAllowed",{tag:r.item,cid:l||0},function(T,s){if(T)return w.error(T);if(!s)return n.tagsinput("remove",r.item,{skipRemoveCheck:!0});$(window).trigger("action:tag.added",{cid:l,tagEl:n,tag:r.item,inputAutocomplete:a}),a.length&&a.autocomplete("close")})}})}),a.attr("tabIndex",n.attr("tabIndex")),a.on("blur",function(){m(a)}),$('[component="composer/tag/dropdown"]').on("click","li",function(){var r=$(this).attr("data-tag");return r&&R([r],n),!1})}},x.isEnoughTags=function(d){return x.getTags(d).length>=P},x.minTagCount=function(){return P},x.onChangeCategory=function(d,g,n,a){var r=d.find('[component="composer/tag/dropdown"]');r.length&&(f(d,g,a),r.toggleClass("hidden",!a.tagWhitelist||!a.tagWhitelist.length),a.tagWhitelist&&app.parseAndTranslate("composer","tagWhitelist",{tagWhitelist:a.tagWhitelist},function(l){r.find(".dropdown-menu").html(l)}))};function f(d,g,n){var a=d.find(".tags"),r=d.find(".bootstrap-tagsinput input");r.length&&(n.hasOwnProperty("minTags")&&(P=n.minTags),n.hasOwnProperty("maxTags")&&(b=n.maxTags),n.tagWhitelist&&n.tagWhitelist.length?(r.attr("readonly",""),r.attr("placeholder",""),a.tagsinput("items").slice().forEach(function(l){n.tagWhitelist.indexOf(l)===-1&&a.tagsinput("remove",l)})):(r.removeAttr("readonly"),r.attr("placeholder",d.find("input.tags").attr("placeholder"))),d.find(".tags-container").toggleClass("haswhitelist",!!(n.tagWhitelist&&n.tagWhitelist.length)),d.find(".tags-container").toggleClass("hidden",n.privileges&&n.privileges.hasOwnProperty("topics:tag")&&!n.privileges["topics:tag"]||b===0&&!g&&!g.tags&&!g.tags.length),n.privileges&&n.privileges.hasOwnProperty("topics:tag")&&!n.privileges["topics:tag"]&&a.tagsinput("removeAll"),$(window).trigger("action:tag.toggleInput",{postContainer:d,tagWhitelist:n.tagWhitelist,tagsInput:r}))}function m(d){var g=jQuery.Event("keypress");g.which=13,g.keyCode=13,setTimeout(function(){d.trigger(g)},100)}function R(d,g){if(d&&d.length)for(var n=0;n<d.length;++n)g.tagsinput("add",d[n])}return x.getTags=function(d){return $('.composer[data-uuid="'+d+'"] .tags').tagsinput("items")},x}).apply(j,S),E!==void 0&&(M.exports=E)}),36244:((M,j,c)=>{var S,E;S=[c(89596),c(13342),c(17459),c(29930),c(43103),c(64061)],E=(function(w,x,P,b,f){var m={inProgress:{}},R="";m.initialize=function(s){g(s),n(s),d(s),P.translate("[[modules:composer.uploading, 0%]]",function(v){R=v})};function d(s){var v=$('.composer[data-uuid="'+s+'"]');v.find("#files").on("change",function(p){var C=(p.target||{}).files||($(this).val()?[{name:$(this).val(),type:utils.fileMimeType($(this).val())}]:null);C&&l({files:C,post_uuid:s,route:"/api/post/upload"})})}function g(s){var v=$('.composer[data-uuid="'+s+'"]');f.handleDragDrop({container:v,callback:function(p){l({files:p.files,post_uuid:s,route:"/api/post/upload",formData:p.formData})}})}function n(s){var v=$('.composer[data-uuid="'+s+'"]');f.handlePaste({container:v,callback:function(p){l({files:p.files,fileNames:p.fileNames,post_uuid:s,route:"/api/post/upload",formData:p.formData})}})}function a(s){return s.replace(/[-[\]{}()*+?.,\\^$|#\s]/g,"\\$&")}function r(s,v,p){return s.slice(0,v)+p+s.slice(v)}function l(s){var v=[...s.files],p=s.post_uuid,C=$('.composer[data-uuid="'+p+'"]'),U=C.find("textarea"),G=U.val(),K=C.find("#fileForm"),i=!1;K.attr("action",config.relative_path+s.route);var B=x.getSelectedCid();!B&&ajaxify.data.cid&&(B=ajaxify.data.cid);var O=0,u=!1;for(O=0;O<v.length;++O)if(u=v[O].type.match(/image./),u&&!app.user.privileges["upload:post:image"]||!u&&!app.user.privileges["upload:post:file"])return b.error("[[error:no-privileges]]");var y=[];let A="";for(O=0;O<v.length;++O){if(y.push(O+"_"+Date.now()+"_"+(s.fileNames?s.fileNames[O]:v[O].name)),u=v[O].type.match(/image./),!app.user.isAdmin&&v[O].size>parseInt(config.maximumFileSize,10)*1024)return K[0].reset(),b.error("[[error:file-too-big, "+config.maximumFileSize+"]]");A+=(u?"!":"")+"["+y[O]+"]("+R+") "}const ne=U.getCursorPosition(),oe=G.length;G=r(G,ne,A),K.length&&C.find('[data-action="post"]').prop("disabled",!0),U.val(G),$(window).trigger("action:composer.uploadStart",{post_uuid:p,files:y.map(function(V,F){return{filename:V.replace(/^\d+_\d{13}_/,""),isImage:/image./.test(v[F].type)}}),text:R}),K.off("submit").submit(function(){function V(F,W,N){var _;N&&(_=F.replace(/^\d+_\d{13}_/,""));var X=U.val(),Z=new RegExp(a(F)+"]\\([^)]+\\)","g");U.val(X.replace(Z,(_||F)+"]("+W+")")),$(window).trigger("action:composer.uploadUpdate",{post_uuid:p,filename:F,text:W})}return m.inProgress[p]=m.inProgress[p]||[],m.inProgress[p].push(1),s.formData&&s.formData.append("cid",B),$(this).ajaxSubmit({headers:{"x-csrf-token":config.csrf_token},resetForm:!0,clearForm:!0,formData:s.formData,data:{cid:B},error:function(F){i=!0,C.find('[data-action="post"]').prop("disabled",!1);const W=T(F,p);for(var N=0;N<v.length;++N)V(y[N],W,!0);w.render(C)},uploadProgress:function(F,W,N,_){P.translate("[[modules:composer.uploading, "+_+"%]]",function(X){if(!i)for(var Z=0;Z<v.length;++Z)V(y[Z],X)})},success:function(F){const W=F.response.images;if(i=!0,W&&W.length)for(var N=0;N<W.length;++N)W[N].filename=y[N].replace(/^\d+_\d{13}_/,""),W[N].isImage=/image./.test(v[N].type),V(y[N],W[N].url,!0);w.render(C),U.prop("selectionEnd",ne+U.val().length-oe),U.focus(),C.find('[data-action="post"]').prop("disabled",!1),$(window).trigger("action:composer.upload",{post_uuid:p,files:W})},complete:function(){K[0].reset(),m.inProgress[p].pop()}}),!1}),K.submit()}function T(s,v){var p=s.responseJSON&&(s.responseJSON.error||s.responseJSON.status&&s.responseJSON.status.message)||"[[error:parse-error]]";return s&&s.status===413&&(p=s.statusText||"Request Entity Too Large"),b.error(p),$(window).trigger("action:composer.uploadError",{post_uuid:v,message:p}),p}return m}).apply(j,S),E!==void 0&&(M.exports=E)}),41644:((M,j,c)=>{var S,E;S=[c(65348),c(14063),c(49897)],E=(function(w,x,P){var b={},f;b.init=function(n,a){var r=n.find(".category-list-container");r.length&&(n.on("action:composer.resize",function(){m(n)}),b.updateTaskbar(n,a),f=w.init(r.find('[component="category-selector"]'),{privilege:"topics:create",states:["watching","tracking","notwatching","ignoring"],onSelect:function(l){a.hasOwnProperty("cid")&&g(n,a,l)}}),f&&(a.cid&&a.category?f.selectedCategory={cid:a.cid,name:a.category.name}:ajaxify.data.template.compose&&ajaxify.data.selectedCategory&&(f.selectedCategory={cid:ajaxify.data.cid,name:ajaxify.data.selectedCategory}),n.find(".category-name").translateHtml(f.selectedCategory?f.selectedCategory.name:"[[modules:composer.select-category]]").on("click",function(){w.modal({privilege:"topics:create",states:["watching","tracking","notwatching","ignoring"],openOnLoad:!0,showLinks:!1,onSubmit:function(l){n.find(".category-name").text(l.name),f.selectCategory(l.cid),a.hasOwnProperty("cid")&&g(n,a,l)}})}),m(n)))};function m(n){n.find('.category-list-container [component="category-selector"]').toggleClass("dropup",n.outerHeight()<$(window).height()/2)}b.getSelectedCid=function(){var n;return f&&(n=f.getSelectedCategory()),n?n.cid:0},b.updateTaskbar=function(n,a){parseInt(a.cid,10)&&P.get(`/categories/${a.cid}`,{}).then(function(r){R(n,r)})};function R(n,a){if(a){var r=n.attr("data-uuid");x.update("composer",r,{image:a.backgroundImage,color:a.color,"background-color":a.bgColor,icon:a.icon&&a.icon.slice(3)})}}function d(n,a,r){const l=n.find("textarea.write").val(),T=r&&r.topicTemplate;a&&(!l.length||l===T)&&l!==a.topicTemplate&&n.find("textarea.write").val(a.topicTemplate).trigger("input")}async function g(n,a,r){const l=a.category;a.cid=r.cid;const T=await window.fetch(`${config.relative_path}/api/category/${encodeURIComponent(r.cid)}`).then(s=>s.json());a.category=T,R(n,T),d(n,T,l),c.e(56382).then(function(){var s=[c(72573),c(52543),c(92762)];(function(v,p,C){v.onChangeCategory(T),p.onChangeCategory(n,a,r.cid,T),C.onChangeCategory(n,a),$(window).trigger("action:composer.changeCategory",{postContainer:n,postData:a,selectedCategory:r,categoryData:T})}).apply(null,s)}).catch(c.oe)}return b}).apply(j,S),E!==void 0&&(M.exports=E)}),49641:((M,j,c)=>{var S,E;S=[c(14063),c(17459),c(31494),c(449),c(74566),c(52543),c(13342),c(89596),c(99594),c(88518),c(72573),c(92762),c(41088),c(36159),c(49897),c(33530),c(29930),c(91749),c(10870),c(69749),c(51916)],E=(function(w,x,P,b,f,m,R,d,g,n,a,r,l,T,s,v,p,C,U,G,K){var i={active:void 0,posts:{},bsEnvironment:void 0,formatting:void 0};$(window).off("resize",O).on("resize",O),O(),$(window).on("action:composer.topics.post",function(e,t){localStorage.removeItem("category:"+t.data.cid+":bookmark"),localStorage.removeItem("category:"+t.data.cid+":bookmark:clicked")}),$(window).on("popstate",function(){var e=utils.findBootstrapEnvironment();if(i.active&&(e==="xs"||e==="sm")){if(!i.posts[i.active].modified){i.discard(i.active),i.discardConfirm&&i.discardConfirm.length&&(i.discardConfirm.modal("hide"),delete i.discardConfirm);return}x.translate("[[modules:composer.discard]]",function(t){i.discardConfirm=v.confirm(t,function(o){o?i.discard(i.active):i.posts[i.active].modified=!0}),i.posts[i.active].modified=!1})}});function B(){var e=i.bsEnvironment;(ajaxify.data.template.compose===!0||e==="xs"||e==="sm")&&history.back()}function O(){var e=utils.findBootstrapEnvironment(),t=e==="xs"||e==="sm";d.toggle&&(d.env!==e&&t&&(d.env=e,d.toggle(!1)),d.env=e),i.active!==void 0&&(g.reposition($('.composer[data-uuid="'+i.active+'"]')),!t&&window.location.pathname.startsWith(config.relative_path+"/compose")?history.back():t&&!window.location.pathname.startsWith(config.relative_path+"/compose")&&V()),i.bsEnvironment=e}function u(e){var t,o;e.hasOwnProperty("cid")?t="cid":e.hasOwnProperty("tid")?t="tid":e.hasOwnProperty("pid")&&(t="pid"),o=e[t];for(const h of Object.keys(i.posts))if(i.posts[h].hasOwnProperty(t)&&o===i.posts[h][t])return h;return!1}function y(e){if(e){var t=utils.generateUUID(),o=u(e);if(o)return w.updateActive(o),i.load(o);var h="[[topic:composer.new-topic]]";e.action==="posts.reply"?h="[[topic:composer.replying-to]]":e.action==="posts.edit"&&(h="[[topic:composer.editing-in]]"),x.translate(h,function(L){w.push("composer",t,{title:L.replace("%1",'"'+e.title+'"')})}),i.posts[t]=e,i.load(t)}}async function A(e,t){$('.composer[data-uuid="'+e+'"]').find(".composer-submit").removeAttr("disabled");const{showAlert:o}=await C.fire("filter:composer.error",{post_uuid:e,message:t,showAlert:!0});o&&p.alert({type:"danger",timeout:1e4,title:"",message:t,alert_id:"post_error"})}i.findByTid=function(e){for(const t of Object.keys(i.posts))if(i.posts[t].hasOwnProperty("tid")&&String(i.posts[t].tid)===String(e))return t;return null},i.addButton=function(e,t,o){b.addButton(e,t,o)},i.newTopic=async e=>{let t={save_id:e.save_id,action:"topics.post",cid:e.cid,handle:e.handle,title:e.title||"",body:e.body||"",tags:e.tags||[],thumbs:e.thumbs||[],modified:!!(e.title&&e.title.length||e.body&&e.body.length),isMain:!0};({pushData:t}=await C.fire("filter:composer.topic.push",{data:e,pushData:t})),y(t)},i.addQuote=function(e){e.uuid=e.uuid||i.active;var t=(e.title||"").replace(/([\\`*_{}[\]()#+\-.!])/g,"\\$1").replace(/\[/g,"&#91;").replace(/\]/g,"&#93;").replace(/%/g,"&#37;").replace(/,/g,"&#44;");e.body&&(e.body="> "+e.body.replace(/\n/g,`
> `)+`

`);var o="["+t+"]("+config.relative_path+"/post/"+encodeURIComponent(e.selectedPid||e.toPid)+")";if(e.uuid===void 0){e.title&&(e.selectedPid||e.toPid)?i.newReply({tid:e.tid,toPid:e.toPid,title:e.title,body:"[[modules:composer.user-said-in, "+e.username+", "+o+`]]
`+e.body}):i.newReply({tid:e.tid,toPid:e.toPid,title:e.title,body:"[[modules:composer.user-said, "+e.username+`]]
`+e.body});return}else e.uuid!==i.active&&i.load(e.uuid);var h=$('.composer[data-uuid="'+e.uuid+'"]'),L=h.find("textarea"),I=L.val();e.title&&(e.selectedPid||e.toPid)?x.translate("[[modules:composer.user-said-in, "+e.username+", "+o+`]]
`,config.defaultLang,z):x.translate("[[modules:composer.user-said, "+e.username+`]]
`,config.defaultLang,z);function z(J){i.posts[e.uuid].body=(I.length?I+`

`:"")+J+e.body,L.val(i.posts[e.uuid].body),X(h),d.render(h)}},i.newReply=function(e){x.translate(e.body,config.defaultLang,function(t){y({save_id:e.save_id,action:"posts.reply",tid:e.tid,toPid:e.toPid,title:e.title,body:t,modified:!!(t&&t.length),isMain:!1})})},i.editPost=function(e){socket.emit("plugins.composer.push",e.pid,function(t,o){if(t)return p.error(t);o.save_id=e.save_id,o.action="posts.edit",o.pid=e.pid,o.modified=!1,e.body&&(o.body=e.body,o.modified=!0),e.title&&(o.title=e.title,o.modified=!0),y(o)})},i.load=function(e){var t=$('.composer[data-uuid="'+e+'"]');t.length?(_(e),g.reposition(t),X(t),re()):i.formatting?oe(e):socket.emit("plugins.composer.getFormattingOptions",function(o,h){if(o)return p.error(o);i.formatting=h,oe(e)})},i.enhance=function(e,t,o){!t&&!o&&(t=utils.generateUUID(),i.posts[t]=ajaxify.data,o=ajaxify.data,e.attr("data-uuid",t)),R.init(e,i.posts[t]),a.init(e,i.posts),b.addHandler(e),b.addComposerButtons(),d.handleToggler(e),r.showAlert(e,o),P.initialize(t),m.init(e,i.posts[t]),n.init(e,t),e.on("change","input, textarea",function(){i.posts[t].modified=!0}),e.on("click",".composer-submit",function(I){I.preventDefault(),I.stopPropagation(),$(this).attr("disabled",!0),Z(t)}),c.e(6411).then(function(){var I=[c(6411)];(function(z){z(e.get(0)).bind("mod+enter",function(){e.find(".composer-submit").attr("disabled",!0),Z(t)})}).apply(null,I)}).catch(c.oe),e.find(".composer-discard").on("click",function(I){if(I.preventDefault(),!i.posts[t].modified)return i.discard(t),B();b.exitFullscreen();var z=$(this).prop("disabled",!0);x.translate("[[modules:composer.discard]]",function(J){v.confirm(J,function(ee){ee&&(i.discard(t),B()),z.prop("disabled",!1)})})}),e.find(".composer-minimize, .minimize .trigger").on("click",function(I){I.preventDefault(),I.stopPropagation(),i.minimize(t)});const h=e.find("textarea");h.on("input propertychange",utils.debounce(function(){d.render(e)},250)),h.on("scroll",function(){d.matchScroll(e)}),f.init(e,o);const L=f.get(o.save_id);d.render(e,function(){d.matchScroll(e)}),o.action==="posts.edit"&&!utils.isNumber(o.pid)&&F(e),W(e),N(e),X(e),(o.action==="posts.edit"||o.action==="topics.post")&&i.updateThumbCount(t,e),K.isEnabled||$('[data-format="zen"]').parent().addClass("hidden"),C.fire("action:composer.enhanced",{postContainer:e,postData:o,draft:L})};async function ne(e){const{template:t}=ajaxify.data,{cid:o}=e;if((t.category||t.world)&&String(o)===String(ajaxify.data.cid))return ajaxify.data;if(o){const h=o!==-1?`/api/category/${encodeURIComponent(e.cid)}`:"/api/world";return await s.get(h,{})}return null}async function oe(e){var t=i.posts[e],o=t?t.hasOwnProperty("cid"):!1,h=t?!!t.isMain:!1,L=t?!!t.pid:!1,I=t?parseInt(t.uid,10)===0:!1;const z=t.timestamp>Date.now();var J=t.title.replace(/%/g,"&#37;").replace(/,/g,"&#44;");t.category=await ne(t);const ee=t.category?t.category.privileges:ajaxify.data.privileges,k=o&&t.category?t.category.topicTemplate:null;var Q={topicTitle:J,titleLength:J.length,body:x.escape(utils.escapeHTML(k||t.body)),mobile:i.bsEnvironment==="xs"||i.bsEnvironment==="sm",resizable:!0,thumb:t.thumb,isTopicOrMain:o||h,maximumTitleLength:config.maximumTitleLength,maximumPostLength:config.maximumPostLength,minimumTagLength:config.minimumTagLength,maximumTagLength:config.maximumTagLength,"composer:showHelpTab":config["composer:showHelpTab"],isTopic:o,isEditing:L,canSchedule:!!(h&&ee&&(ee["topics:schedule"]&&!L||z&&ee.view_scheduled)),canUploadImage:app.user.privileges["upload:post:image"]&&(config.maximumFileSize>0||app.user.isAdmin),canUploadFile:app.user.privileges["upload:post:file"]&&(config.maximumFileSize>0||app.user.isAdmin),showHandleInput:config.allowGuestHandles&&(app.user.uid===0||L&&I&&app.user.isAdmin),handle:t?t.handle||"":void 0,formatting:i.formatting,tagWhitelist:t.category?t.category.tagWhitelist:ajaxify.data.tagWhitelist,privileges:app.user.privileges,selectedCategory:t.category,submitOptions:[]};Q.mobile&&(V(),app.toggleNavbar(!1)),t.mobile=i.bsEnvironment==="xs"||i.bsEnvironment==="sm",{postData:t,createData:Q}=await C.fire("filter:composer.create",{postData:t,createData:Q}),app.parseAndTranslate("composer",Q,function(q){if(!$('.composer.composer[data-uuid="'+e+'"]').length){q=$(q),q.find(".title").each(function(){$(this).text(x.unescape($(this).text()))}),q.attr("data-uuid",e),$(document.body).append(q);var D=$(q[0]);if(g.reposition(D),i.enhance(D,e,t),_(e),D.on("click",function(){w.isActive(e)||w.updateActive(e)}),g.handleResize(D),i.bsEnvironment==="xs"||i.bsEnvironment==="sm"){var H=D.find(".composer-submit"),ae=D.find(".mobile-navbar .composer-submit"),te=D.find(".write"),ie=te.attr("tabindex");H.removeAttr("tabindex"),ae.attr("tabindex",parseInt(ie,10)+1)}$(window).trigger("action:composer.loaded",{postContainer:D,post_uuid:e,composerData:i.posts[e],formatting:i.formatting}),l.apply(D.find(".write")),X(D),re()}})}function V(){var e="compose?p="+window.location.pathname,t=window.location.pathname.slice(1)+window.location.search;t.startsWith(config.relative_path.slice(1))&&(t=t.slice(config.relative_path.length)),window.history.replaceState({url:null,returnPath:t},t,config.relative_path+"/"+t),window.history.pushState({url:e},e,`${config.relative_path}/${t}`)}function F(e){p.alert({title:"[[modules:composer.remote-pid-editing]]",message:"[[modules:composer.remote-pid-content-immutable]]",timeout:15e3});var t=e.find(".write-container");t.addClass("hidden")}function W(e){const t=e.find('[data-action="help"]');t.on("click",async function(){const o=await socket.emit("plugins.composer.renderHelp");o&&o.length>0&&v.dialog({size:"large",message:o,onEscape:!0,backdrop:!0,onHidden:function(){t.focus()}})})}function N(e){var t=e.attr("data-uuid"),o=i.posts[t]&&i.posts[t].action==="posts.edit",h=utils.findBootstrapEnvironment(),L=h==="xs"||h==="sm";o||L||G.enableQuickSearch({searchElements:{inputEl:e.find("input.title"),resultEl:e.find(".quick-search-container")},searchOptions:{composer:1},hideOnNoMatches:!0,hideDuringSearch:!0})}function _(e){i.active&&i.active!==e&&i.minimize(i.active),i.active=e;const t=$('.composer[data-uuid="'+e+'"]');t.css("visibility","visible"),$(window).trigger("action:composer.activate",{post_uuid:e,postContainer:t})}function X(e){setTimeout(function(){var t=e.find("input.title");t.length?t.focus():e.find("textarea").focus().putCursorAtEnd()},20)}async function Z(e){var t=i.posts[e],o=$('.composer[data-uuid="'+e+'"]'),h=o.find(".handle"),L=o.find(".title"),I=o.find("textarea"),z=o.find("input#topic-thumb-url"),J=t.hasOwnProperty("template")&&t.template.compose===!0;const ee=o.find(".composer-submit");L.val(L.val().trim()),I.val(utils.rtrim(I.val())),z.length&&z.val(z.val().trim());var k=t.action,Q=(t.hasOwnProperty("cid")||parseInt(t.pid,10))&&o.find("input.title").length,q=!Q||Q&&t.cid,D={post_uuid:e,postData:t,postContainer:o,titleEl:L,titleLen:L.val().length,bodyEl:I,bodyLen:I.val().length};if(await C.fire("filter:composer.check",D),$(window).trigger("action:composer.check",D),D.error)return A(e,D.error);if(P.inProgress[e]&&P.inProgress[e].length)return A(e,"[[error:still-uploading]]");if(Q&&D.titleLen<parseInt(config.minimumTitleLength,10))return A(e,"[[error:title-too-short, "+config.minimumTitleLength+"]]");if(Q&&D.titleLen>parseInt(config.maximumTitleLength,10))return A(e,"[[error:title-too-long, "+config.maximumTitleLength+"]]");if(k==="topics.post"&&!q)return A(e,"[[error:category-not-selected]]");if(D.bodyLen<parseInt(config.minimumPostLength,10))return A(e,"[[error:content-too-short, "+config.minimumPostLength+"]]");if(D.bodyLen>parseInt(config.maximumPostLength,10))return A(e,"[[error:content-too-long, "+config.maximumPostLength+"]]");if(Q&&!m.isEnoughTags(e))return A(e,"[[error:not-enough-tags, "+m.minTagCount()+"]]");if(a.isActive()&&a.getTimestamp()<=Date.now())return A(e,"[[error:scheduling-to-past]]");let H={uuid:e},ae="post",te="";k==="topics.post"?(te="/topics",H={...H,handle:h?h.val():void 0,title:L.val(),content:I.val(),thumb:z.val()||"",cid:R.getSelectedCid(),tags:m.getTags(e),thumbs:t.thumbs||[],timestamp:a.getTimestamp()}):k==="posts.reply"?(te=`/topics/${t.tid}`,H={...H,tid:t.tid,handle:h?h.val():void 0,content:I.val(),toPid:t.toPid}):k==="posts.edit"&&(ae="put",te=`/posts/${encodeURIComponent(t.pid)}`,H={...H,pid:t.pid,handle:h?h.val():void 0,content:I.val(),title:L.val(),thumbs:t.thumbs||[],tags:m.getTags(e),timestamp:a.getTimestamp()});var ie={composerEl:o,action:k,composerData:H,postData:t,redirect:!0};await C.fire("filter:composer.submit",ie),C.fire("action:composer.submit",Object.freeze(ie));var le=$('#taskbar .composer[data-uuid="'+e+'"] i'),ce=o.find(".write");le.removeClass("fa-plus").addClass("fa-circle-o-notch fa-spin"),i.minimize(e),ce.prop("readonly",!0),s[ae](te,H).then(Y=>{ee.removeAttr("disabled"),t.submitted=!0,i.discard(e),f.removeDraft(t.save_id),Y.queued?p.alert({type:"success",title:"[[global:alert.success]]",message:Y.message,timeout:1e4,clickfn:function(){ajaxify.go(`/post-queue/${Y.id}`)}}):k==="topics.post"?ie.redirect&&ajaxify.go("topic/"+Y.slug,void 0,J||i.bsEnvironment==="xs"||i.bsEnvironment==="sm"):k==="posts.reply"?J||i.bsEnvironment==="xs"||i.bsEnvironment==="sm"?window.history.back():ie.redirect&&(ajaxify.data.template.name!=="topic"||ajaxify.data.template.topic&&parseInt(t.tid,10)!==parseInt(ajaxify.data.tid,10))&&ajaxify.go("post/"+Y.pid):B(),C.fire("action:composer."+k,{composerData:H,data:Y})}).catch(Y=>{if(i.load(e),ce.prop("readonly",!1),Y.message==="[[error:email-not-confirmed]]")return U.showEmailConfirmWarning(Y.message);A(e,Y.message)})}function re(){$("html").addClass("composing")}function se(){$("#content").css({paddingBottom:0}),$("html").removeClass("composing"),app.toggleNavbar(!0),b.exitFullscreen()}return i.discard=function(e){if(i.posts[e]){var t=i.posts[e],o=$('.composer[data-uuid="'+e+'"]');o.remove(),f.removeDraft(t.save_id),T.deleteAll(e),w.discard("composer",e),$('[data-action="post"]').removeAttr("disabled"),C.fire("action:composer.discard",{post_uuid:e,postData:t}),delete i.posts[e],i.active=void 0}a.reset(),se()},i.close=i.discard,i.minimize=function(e){var t=$('.composer[data-uuid="'+e+'"]');t.css("visibility","hidden"),i.active=void 0,w.minimize("composer",e),$(window).trigger("action:composer.minimize",{post_uuid:e}),se()},i.minimizeActive=function(){i.active&&i.miminize(i.active)},i.updateThumbCount=function(e,t){const o=i.posts[e];if(o&&(o.action==="topics.post"||o.action==="posts.edit"&&o.isMain)){const h=o.thumbs?o.thumbs.length:0;t.find('[data-format="thumbs"]').find(".badge").text(h).toggleClass("hidden",!h)}},i}).apply(j,S),E!==void 0&&(M.exports=E)}),54516:((M,j,c)=>{var S,E;S=[c(89596),c(34405)],E=(function(w,x){var P={_active:{}};return $(window).on("action:composer.discard",function(b,f){P._active.hasOwnProperty(f.post_uuid)&&(P._active[f.post_uuid].destroy(),delete P._active[f.post_uuid])}),P.init=function(b,f){var m=b.find(".write"),R="composer-autocomplete-dropdown-"+f,d;if(m.length){var g={element:m,strategies:[],options:{style:{"z-index":2e4},className:R+" dropdown-menu textcomplete-dropdown"}};m.on("keyup",function(){clearTimeout(d),d=setTimeout(function(){var n=document.querySelector("."+R);if(n){var a=n.getBoundingClientRect(),r=parseFloat(n.style.marginTop,10)||0,l=window.innerHeight+r-10-a.bottom;n.style.marginTop=Math.min(l,0)+"px"}},0)}),$(window).trigger("composer:autocomplete:init",g),P._active[f]=x.setup(g),g.element.on("textComplete:select",function(){w.render(b)})}},P}).apply(j,S),E!==void 0&&(M.exports=E)}),59367:((M,j,c)=>{var S,E;S=[c(81335),c(33530),c(29930),c(17459)],E=(function(w,x,P,b){const f={},m={timestamp:0,open:!1,edit:!1,posts:{}};let R=[],d,g,n,a;const r={el:null,defaultText:"",activeText:""},l={el:null,icon:null,defaultText:"",activeText:""};let T,s;$(window).on("action:composer.activate",U),f.init=function(u,y){m.timestamp=0,m.posts=y,b.translateKeys(["[[topic:composer.post-later]]","[[modules:composer.change-schedule-date]]"]).then(A=>{r.defaultText=A[0],r.activeText=A[1]}),R=u[0].querySelectorAll(".display-scheduler"),d=u[0].querySelectorAll(".display-scheduler i"),r.el=u[0].querySelector(".dropdown-item.display-scheduler"),g=u[0].querySelector(".dropdown-item.cancel-scheduling"),n=u.find('[component="composer/submit/container"]'),a=u.find('[component="composer/submit/options/container"]'),l.el=u[0].querySelector(".composer-submit:not(.btn-sm)"),l.icon=l.el.querySelector("i"),l.defaultText=l.el.lastChild.textContent,l.activeText=l.el.getAttribute("data-text-variant"),g.addEventListener("click",i),R.forEach(A=>A.addEventListener("click",v))},f.getTimestamp=function(){return!f.isActive()||isNaN(m.timestamp)?0:m.timestamp},f.isActive=function(){return m.timestamp>0},f.isOpen=function(){return m.open},f.reset=function(){m.timestamp=0},f.onChangeCategory=function(u){O(u.privileges["topics:schedule"]),B(!1);const y=u.privileges["topics:schedule"]||a.attr("data-submit-options")>0;n.find(".composer-submit").toggleClass("rounded-1",!y),a.toggleClass("hidden",!y),f.reset()};async function v(){const u=await w.render("modals/topic-scheduler");x.dialog({message:u,title:"[[modules:composer.schedule-for]]",className:"topic-scheduler",onShown:p,onHidden:C,onEscape:!0,buttons:{cancel:{label:m.timestamp?"[[modules:composer.cancel-scheduling]]":"[[modules:bootbox.cancel]]",className:(m.timestamp?"btn-warning":"btn-outline-secondary")+(m.edit?" hidden":""),callback:i},set:{label:"[[modules:composer.set-schedule-date]]",className:"btn-primary",callback:K}}})}function p(u){m.open=!0;const y=u.target.querySelector(".datetime-picker");T=y.querySelector('input[type="date"]'),s=y.querySelector('input[type="time"]'),G()}function C(){m.open=!1}function U(u,{post_uuid:y}){m.edit=!1;const A=m.posts[y];A&&A.isMain&&A.timestamp>Date.now()&&(m.timestamp=A.timestamp,m.edit=!0,B())}function G(){const u=new Date,y=new Date(u.getTime()-u.getTimezoneOffset()*6e4).toJSON();if(T.setAttribute("min",y.slice(0,10)),s.setAttribute("min",y.slice(11,-8)),f.isActive()){const A=new Date(m.timestamp-u.getTimezoneOffset()*6e4).toJSON();T.value=A.slice(0,10),s.value=A.slice(11,-8)}}function K(){const u=T.value&&s.value,y=new Date(`${T.value} ${s.value}`).getTime();if(!u||isNaN(y)||y<Date.now()){m.timestamp=0;const A=y<Date.now()?"[[error:scheduling-to-past]]":"[[error:invalid-schedule-date]]";return P.alert({type:"danger",timeout:3e3,title:"",alert_id:"post_error",message:A}),!1}m.timestamp||B(!0),m.timestamp=y}function i(){m.timestamp&&(B(!1),m.timestamp=0)}function B(u=!0){d.forEach(y=>y.classList.toggle("active",u)),l.icon&&(l.icon.classList.toggle("fa-check",!u),l.icon.classList.toggle("fa-clock-o",u)),r.el&&(r.el.textContent=u?r.activeText:r.defaultText,g.classList.toggle("hidden",!u)),l.el.lastChild.textContent=u?l.activeText:l.defaultText}function O(u){R.forEach(y=>y.classList.toggle("hidden",!u))}return f}).apply(j,S),E!==void 0&&(M.exports=E)}),94252:((M,j)=>{var c,S;c=[],S=(function(){const E={};return E.showAlert=async function(w,x){const P=w.find('[component="composer/post-queue/alert"]');if(!config.postQueue||app.user.isAdmin||app.user.isGlobalMod||app.user.isMod){P.remove();return}const b=await socket.emit("plugins.composer.shouldQueue",{postData:x});P.toggleClass("show",b),P.toggleClass("pe-none",!b)},E.onChangeCategory=async function(w,x){config.postQueue&&E.showAlert(w,x)},E}).apply(j,c),S!==void 0&&(M.exports=S)})}]);
