(self.webpackChunknodebb=self.webpackChunknodebb||[]).push([[52185,74566],{12236:((d,m,l)=>{"use strict";var p,f;p=[l(49897),l(29930)],f=(function(h,S){const i={};i.init=function(e,t){const n=e.find(".draft-icon"),s=e.attr("data-uuid");function o(){$(`[component="composer"][data-uuid="${s}"]`).length&&(t.save_id||(t.save_id=utils.generateSaveId(app.user.uid)),i.addToDraftList("available",t.save_id),i.addToDraftList("open",t.save_id),b(e,n,t))}e.on("keyup","textarea, input.handle, input.title",utils.debounce(o,1e3)),e.on("click",'input[type="checkbox"]',utils.debounce(o,1e3)),e.on("click",'[component="category/list"] [data-cid]',utils.debounce(o,1e3)),e.on("itemAdded",".tags",utils.debounce(o,1e3)),e.on("thumb.uploaded",o),n.on("animationend",function(){$(this).toggleClass("active",!1)}),$(window).on("unload",function(){const a=i.getList("open");a.length&&a.forEach(c=>i.removeFromDraftList("open",c))}),i.migrateGuest()};function g(e){return parseInt(e,10)>0?localStorage:sessionStorage}i.get=function(e){if(!e)return null;const t=e.split(":")[1],n=g(t);try{const s=n.getItem(e),o=JSON.parse(s)||null;if(!o)throw new Error(`can't parse draft json for ${e}`);return o.save_id=e,o.timestamp&&(o.timestampISO=utils.toISOString(o.timestamp)),$(window).trigger("action:composer.drafts.get",{save_id:e,draft:o,storage:n}),o}catch{return console.warn(`[composer/drafts] Could not get draft ${e}, removing`),i.removeFromDraftList("available"),i.removeFromDraftList("open"),null}};function b(e,t,n){if(u(app.user.uid?"localStorage":"sessionStorage")&&n&&n.save_id&&e.length){const s=e.find("input.title"),o=s&&s.length&&s.val(),a=e.find("textarea").val(),c=g(app.user.uid);if(a.length||o&&o.length){const r={save_id:n.save_id,action:n.action,text:a,uuid:e.attr("data-uuid"),timestamp:Date.now()};if(n.action==="topics.post"){const y=e.find("input.tags").val();r.tags=y,r.title=o,r.cid=n.cid,r.thumbs=n.thumbs||[]}else n.action==="posts.reply"?(r.title=n.title,r.tid=n.tid,r.toPid=n.toPid):n.action==="posts.edit"&&(r.pid=n.pid,r.title=o||n.title,r.thumbs=n.thumbs||[]);app.user.uid||(r.handle=e.find("input.handle").val()),c.setItem(n.save_id,JSON.stringify(r)),$(window).trigger("action:composer.drafts.save",{storage:c,postData:n,postContainer:e}),t.toggleClass("active",!0)}else i.removeDraft(n.save_id)}}i.removeDraft=function(e){if(!e)return;i.removeFromDraftList("available",e),i.removeFromDraftList("open",e);const t=e.split(":")[1],n=g(t);n.removeItem(e),$(window).trigger("action:composer.drafts.remove",{storage:n,save_id:e})},i.getList=function(e){try{const t=localStorage.getItem(`drafts:${e}`);return JSON.parse(t)||[]}catch{return console.warn("[composer/drafts] Could not read list of available drafts"),[]}},i.addToDraftList=function(e,t){if(!u(app.user.uid?"localStorage":"sessionStorage")||!t)return;const n=i.getList(e);n.includes(t)||(n.push(t),localStorage.setItem("drafts:"+e,JSON.stringify(n)))},i.removeFromDraftList=function(e,t){if(!u(app.user.uid?"localStorage":"sessionStorage")||!t)return;const n=i.getList(e);n.includes(t)&&(n.splice(n.indexOf(t),1),localStorage.setItem("drafts:"+e,JSON.stringify(n)))},i.migrateGuest=function(){if(u("localStorage")&&app.user.uid){const e=/^composer:\d+:\d$/,t=Object.keys(sessionStorage).filter(function(o){return e.test(o)}),n=new Set([]),s=t.map(function(o){const a=o.split(":");return a[1]=app.user.uid,n.add(a.join(":")),a.join(":")});return t.forEach(function(o,a){localStorage.setItem(s[a],sessionStorage.getItem(o)),sessionStorage.removeItem(o)}),n.forEach(function(o){i.addToDraftList("available",o)}),n}},i.listAvailable=function(){return i.getList("available").map(i.get).filter(Boolean)},i.getAvailableCount=function(){return i.listAvailable().length},i.open=function(e){if(!e)return;const t=i.get(e);v(e,t)},i.loadOpen=function(){if(ajaxify.data.template.login||ajaxify.data.template.register||config.hasOwnProperty("openDraftsOnPageLoad")&&!config.openDraftsOnPageLoad)return;const e=i.getList("available"),t=i.getList("open");e.length&&e.forEach(function(n){if(!n||t.includes(n))return;const s=i.get(n);if(!s||!s.text&&!s.title){i.removeFromDraftList("available",n),i.removeFromDraftList("open",n);return}v(n,s)})};function v(e,t){const s=e.split(":")[1];parseInt(app.user.uid,10)===parseInt(s,10)&&Promise.all([l.e(20056),l.e(23662),l.e(65285),l.e(40559),l.e(449),l.e(5785),l.e(58540)]).then(function(){var o=[l(71431)];(function(a){t.action==="topics.post"?a.newTopic({save_id:t.save_id,cid:t.cid,handle:app.user&&app.user.uid?void 0:utils.escapeHTML(t.handle),title:utils.escapeHTML(t.title),body:t.text,tags:String(t.tags||"").split(","),thumbs:t.thumbs||[]}):t.action==="posts.reply"?h.get("/topics/"+t.tid,{},function(c,r){if(c)return S.error(c);a.newReply({save_id:t.save_id,tid:t.tid,toPid:t.toPid,title:r.title,body:t.text})}):t.action==="posts.edit"&&a.editPost({save_id:t.save_id,pid:t.pid,title:t.title?utils.escapeHTML(t.title):void 0,body:t.text,thumbs:t.thumbs||[]})}).apply(null,o)}).catch(l.oe)}function u(e){var t;try{t=window[e];var n="__storage_test__";return t.setItem(n,n),t.removeItem(n),!0}catch(s){return s instanceof DOMException&&(s.code===22||s.code===1014||s.name==="QuotaExceededError"||s.name==="NS_ERROR_DOM_QUOTA_REACHED")&&t&&t.length!==0}}return i}).apply(m,p),f!==void 0&&(d.exports=f)}),74566:((d,m,l)=>{d.exports=l(12236)})}]);
