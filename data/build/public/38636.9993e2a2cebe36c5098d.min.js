"use strict";(self.webpackChunknodebb=self.webpackChunknodebb||[]).push([[33085,34405,38636],{34405:((D,j,m)=>{var w,A;w=[m(49897),m(29930),m(36e3),m(9787),m(35786)],A=(function(x,E,{Textcomplete:f},{TextareaEditor:g},{ContenteditableEditor:v}){const o={},u={delay:200,appendTo:null};o.init=c=>{const s={...u,...c},{input:d,onSelect:i}=s;app.loadJQueryUI(function(){d.autocomplete({...s,open:function(){$(this).autocomplete("widget").css("z-index",100005)},select:function(p,y){l(d,i,p,y)}})})},o.user=function(c,s,d){typeof s=="function"&&(d=s,s={}),s=s||{},o.init({input:c,onSelect:d,source:(i,p)=>{s.query=i.term,x.get("/api/users",s,function(y,C){if(y)return E.error(y);if(C&&C.users){const b=C.users.map(function(n){const S=$("<div></div>").html(n.username).text();return n&&{label:S,value:S,user:{uid:n.uid,name:n.username,slug:n.userslug,username:n.username,userslug:n.userslug,displayname:n.displayname,picture:n.picture,banned:n.banned,"icon:text":n["icon:text"],"icon:bgColor":n["icon:bgColor"]}}});p(b)}$(".ui-autocomplete a").attr("data-ajaxify","false")})}})},o.group=function(c,s){o.init({input:c,onSelect:s,source:(d,i)=>{socket.emit("groups.search",{query:d.term},function(p,y){if(p)return E.error(p);if(y&&y.length){const C=y.map(function(b){return b&&{label:b.name,value:b.name,group:b}});i(C)}$(".ui-autocomplete a").attr("data-ajaxify","false")})}})},o.tag=function(c,s){o.init({input:c,onSelect:s,delay:100,source:(d,i)=>{socket.emit("topics.autocompleteTags",{query:d.term,cid:ajaxify.data.cid||0},function(p,y){if(p)return E.error(p);y&&i(y),$(".ui-autocomplete a").attr("data-ajaxify","false")})}})};function l(c,s,d,i){s=s||function(){};const p=jQuery.Event("keypress");p.which=13,p.keyCode=13,setTimeout(function(){c.trigger(p)},100),s(d,i)}return o.setup=function({element:c,strategies:s,options:d}){const i=c.get(0);if(i){var p;if(i.nodeName==="TEXTAREA"||i.nodeName==="INPUT"?p=new g(i):i.nodeName==="DIV"&&i.getAttribute("contenteditable")==="true"&&(p=new v(i)),!p)throw new Error("unknown target element type");i.setAttribute("dir",document.querySelector("html").getAttribute("data-dir"));var y=new f(p,s,{dropdown:d});return y.on("rendered",function(){y.dropdown.items.length&&y.dropdown.items[0].activate()}),y}},o}).apply(j,w),A!==void 0&&(D.exports=A)}),38636:((D,j,m)=>{var w,A;w=[m(52473),m(6411),m(26832),m(80083),m(58836),m(60419),m(72513),m(65161),m(93230),m(34405),m(91749),m(33530),m(29930),m(92619),m(49897),m(43103)],A=(function(x,E,f,g,v,o,u,l,c,s,d,i,p,y,C,b){const n={initialised:!1,activeAutocomplete:{}};let S=!1,T=null;return $(window).on("action:ajaxify.start",function(){n.destroyAutoComplete(ajaxify.data.roomId),ajaxify.data.template.chats&&(ajaxify.data.roomId&&socket.emit("modules.chats.leave",ajaxify.data.roomId),ajaxify.data.publicRooms&&socket.emit("modules.chats.leavePublic",ajaxify.data.publicRooms.map(t=>t.roomId)))}),n.init=function(){utils.isMobile()||$('.chats-full [data-bs-toggle="tooltip"]').tooltip({trigger:"hover",container:"#content"}),socket.emit("modules.chats.enterPublic",ajaxify.data.publicRooms.map(a=>a.roomId));const t=utils.findBootstrapEnvironment();T=$('[component="chat/nav-wrapper"]'),n.initialised||(n.addSocketListeners(),n.addGlobalEventListeners()),f.init(),n.addEventListeners(),n.setActive(ajaxify.data.roomId),(t==="md"||t==="lg"||t==="xl"||t==="xxl")&&n.addHotkeys(),n.initialised=!0;const e=$('[component="chat/message/content"]');if(o.wrapImagesInLinks(e),ajaxify.data.scrollToIndex){o.toggleScrollUpAlert(e);const a=e.find(`[data-index="${ajaxify.data.scrollToIndex-1}"]`);a.length&&e.scrollTop(e.scrollTop()-e.offset().top+a.offset().top)}else o.scrollToBottomAfterImageLoad(e);g.init(),d.fire("action:chat.loaded",$(".chats-full"))},n.addEventListeners=function(){const{roomId:t}=ajaxify.data,e=$('[component="chat/main-wrapper"]'),a=$('[component="chat/message/content"]'),r=x.get("chat/controls");n.addSendHandlers(t,$(".chat-input"),$('.expanded-chat button[data-action="send"]')),n.addPopoutHandler(),n.addActionHandlers(x.get("chat/message/window"),t),n.addManageHandler(t,r.find('[data-action="manage"]')),n.addRenameHandler(t,r.find('[data-action="rename"]')),n.addLeaveHandler(t,r.find('[data-action="leave"]')),n.addDeleteHandler(t,r.find('[data-action="delete"]')),n.addScrollHandler(t,ajaxify.data.uid,a),n.addScrollBottomHandler(t,a),n.addParentHandler(e),n.addCharactersLeftHandler(e),n.addTextareaResizeHandler(e),n.addTypingHandler(e,t),n.addIPHandler(e),n.addCopyTextLinkHandler(e),n.createAutoComplete(t,$('[component="chat/input"]')),n.addUploadHandler({dragDropAreaEl:$(".chats-full"),pasteEl:$('[component="chat/input"]'),uploadFormEl:$('[component="chat/upload"]'),uploadBtnEl:$('[component="chat/upload/button"]'),inputEl:$('[component="chat/input"]')}),$('[data-action="close"]').on("click",function(){n.switchChat()}),u.init(t,e),n.addNotificationSettingHandler(t,e),l.init(t,e),n.addPublicRoomSortHandler(),n.addTooltipHandler(e),c.init(e)},n.addPublicRoomSortHandler=function(){app.user.isAdmin&&!utils.isMobile()&&app.loadJQueryUI(()=>{const t=$('[component="chat/public"]');t.sortable({handle:'[component="chat/public/room/sort/handle"]',items:'[component="chat/public/room"]',axis:"y",update:async function(){const e={roomIds:[],scores:[]};t.find("[data-roomid]").each((a,r)=>{e.roomIds.push($(r).attr("data-roomid")),e.scores.push(a)}),await C.put("/chats/sort",e)}})})},n.addTooltipHandler=function(t){utils.isMobile()||(t.find("[data-manual-tooltip]").tooltip({trigger:"manual",animation:!1,placement:"bottom"}).on("mouseenter",function(e){const a=$(e.target);a.hasClass("dropdown-menu")||!!a.parents(".dropdown-menu").length||$(this).tooltip("show")}).on("click mouseleave",function(){$(this).tooltip("hide")}),t.tooltip({selector:'[component="chat/message/controls"] > .btn-group > button',placement:"top",container:"#content",animation:!1,trigger:"hover"}))},n.addNotificationSettingHandler=function(t,e){const a=e.find('[component="chat/notification/setting"]');a.find("[data-value]").on("click",async function(){a.find("i.fa-check").addClass("hidden");const r=$(this);r.find("i.fa-check").removeClass("hidden"),a.find('[component="chat/notification/setting/icon"]').attr("class",`fa ${r.attr("data-icon")}`),await C.put(`/chats/${t}/watch`,{value:r.attr("data-value")})})},n.addParentHandler=function(t){t.off("click",'[component="chat/message/parent"]').on("click",'[component="chat/message/parent"]',function(){const e=$(this);e.find('[component="chat/message/parent/content"]').toggleClass("line-clamp-1"),e.find(".chat-timestamp").toggleClass("hidden"),e.toggleClass("flex-column").toggleClass("flex-row");const a=e.parents('[component="chat/message/content"]');a.length&&o.isAtBottom(a)&&o.scrollToBottom(a)})},n.addUploadHandler=function(t){b.init({dragDropAreaEl:t.dragDropAreaEl,pasteEl:t.pasteEl,uploadFormEl:t.uploadFormEl,uploadBtnEl:t.uploadBtnEl,route:"/api/post/upload",callback:function(e){const a=t.inputEl;let r=a.val();e.forEach(h=>{r=r+(r.endsWith(`
`)?"":`
`)+(h.isImage?"!":"")+`[${h.filename}](${h.url})
`}),a.val(r).trigger("input")}})},n.addIPHandler=function(t){t.off("click",".chat-ip-button").on("click",".chat-ip-button",async function(e){e.stopPropagation();const a=$(this),r=a.find(".copy .copy-ip-text");let h=a.attr("data-ip");if(h){navigator.clipboard.writeText(h),r.translateText("[[global:copied]]"),setTimeout(()=>r.text(h),2e3);return}const k=a.parents("[data-mid]").attr("data-mid");({ip:h}=await C.get(`/chats/${ajaxify.data.roomId}/messages/${k}/ip`)),a.attr("data-ip",h),a.find(".show").addClass("hidden"),a.find(".copy").removeClass("hidden"),r.text(h)})},n.addCopyTextLinkHandler=function(t){function e(a,r){navigator.clipboard.writeText(r),a.find("i").addClass("fa-check").removeClass("fa-link"),setTimeout(()=>a.find("i").removeClass("fa-check").addClass("fa-link"),2e3)}t.off("click",'[data-action="copy-link"]').on("click",'[data-action="copy-link"]',function(a){a.stopPropagation();const r=$(this),h=r.attr("data-mid");h&&e(r,`${window.location.origin}/message/${h}`)}),t.off("click",'[data-action="copy-text"]').on("click",'[data-action="copy-text"]',function(a){a.stopPropagation();const r=$(this),h=r.parents("[data-mid]");h.length&&e(r,h.find('[component="chat/message/body"]').text().trim())})},n.addPopoutHandler=function(){$('[data-action="pop-out"]').on("click",function(){const t=x.get("chat/input").val(),e=ajaxify.data.roomId;app.previousUrl&&app.previousUrl.match(/chats/)?ajaxify.go("user/"+ajaxify.data.userslug+"/chats",function(){y.openChat(e,ajaxify.data.uid)},!0):(window.history.go(-1),y.openChat(e,ajaxify.data.uid)),$(window).one("action:chat.loaded",function(){x.get("chat/input").val(t)})})},n.addScrollHandler=function(t,e,a){let r=!1,h=a.scrollTop(),k=h;a.off("scroll").on("scroll",utils.debounce(function(){if(parseInt(a.attr("data-ignore-next-scroll"),10)===1){a.removeAttr("data-ignore-next-scroll"),h=a.scrollTop();return}if(o.toggleScrollUpAlert(a),r)return;k=a.scrollTop();const I=k>h?1:-1;h=k;const H=100*(k/(a[0].scrollHeight-a.height())),F=15,M=85;if(!(I===1&&!ajaxify.data.scrollToIndex)&&(H<F&&I===-1||H>M&&I===1)){r=!0;const N=a.children("[data-mid]").not(".new"),P=I>0?N.last():N.first(),B=parseInt(P.attr("data-index"),10)||0;C.get(`/chats/${t}/messages`,{uid:e,start:B,direction:I}).then(W=>{let L=W.messages;if(!L){r=!1;return}if(L=L.filter(function(R){const U=a.find('[component="chat/message"][data-mid="'+R.messageId+'"]');return U.removeClass("new"),!U.length}),!L.length){r=!1;return}o.parseMessage(L,function(R){if(a.attr("data-ignore-next-scroll",1),I>0)R.insertAfter(P),o.onMessagesAddedToDom(R);else{const U=a.scrollTop(),K=a[0].scrollHeight;a.prepend(R),o.onMessagesAddedToDom(R),a.scrollTop(a[0].scrollHeight-K+U)}r=!1})}).catch(p.error)}},100))},n.addScrollBottomHandler=function(t,e){e.parents('[component="chat/message/window"]').find('[component="chat/messages/scroll-up-alert"]').off("click").on("click",function(){ajaxify.data.scrollToIndex&&parseInt(ajaxify.data.roomId,10)===parseInt(t,10)?n.switchChat(t):o.scrollToBottom(e)})},n.addCharactersLeftHandler=function(t){t.find('[component="chat/input"]').on("change keyup paste",function(){o.updateRemainingLength(t)})},n.addTextareaResizeHandler=function(t){const e=t.find('[component="chat/input"]');e.on("input",function(){const a=t.find('[component="chat/message/content"]'),r=o.isAtBottom(a);e.css({height:0}),e.css({height:o.calcAutoTextAreaHeight(e)+"px"}),r&&o.scrollToBottom(a)})},n.addTypingHandler=function(t,e){const a=t.find('[component="chat/input"]');function r(I){C.put(`/chats/${e}/typing`,{typing:I}).catch(p.error)}a.on("focus",()=>a.val()&&r(!0)),a.on("blur",()=>r(!1));let h=0,k=!!a.val();a.on("input",function(){const I=!!a.val();I!==k?(clearTimeout(h),h=0,k=I,r(k)):h||(h=setTimeout(()=>{r(!!a.val()),h=0},5e3))})},n.addActionHandlers=function(t,e){t.on("click","[data-mid] [data-action]",function(){const a=$(this).parents("[data-mid]"),r=a.attr("data-mid"),h=this.getAttribute("data-action");switch($(this).tooltip("dispose"),h){case"reply":o.prepReplyTo(a,t);break;case"edit":o.prepEdit(a,r,e);break;case"delete":o.delete(r,e);break;case"restore":o.restore(r,e);break;case"pin":c.pin(r,e);break;case"unpin":c.unpin(r,e);break}})},n.addHotkeys=function(){E.bind("ctrl+up",function(){const e=$(".chats-list .active").prevAll("[data-roomid]").first();e.length&&e.attr("data-roomid")&&n.switchChat(e.attr("data-roomid"))}),E.bind("ctrl+down",function(){const e=$(".chats-list .active").nextAll("[data-roomid]").first();e.length&&e.attr("data-roomid")&&n.switchChat(e.attr("data-roomid"))}),E.bind("up",function(t){const e=x.get("chat/input");if(t.target===e.get(0)&&!e.val()){const a=x.get("chat/messages").find('.chat-message[data-self="1"]').last();if(!a.length)return;const r=a.attr("data-mid");o.prepEdit(a,r,ajaxify.data.roomId)}})},n.addManageHandler=function(t,e){v.init(t,e)},n.addLeaveHandler=function(t,e){e.on("click",function(){i.confirm({size:"small",title:"[[modules:chat.leave]]",message:'<p>[[modules:chat.leave-prompt]]</p><p class="form-text">[[modules:chat.leave-help]]</p>',callback:function(a){a&&C.del(`/chats/${t}/users/${app.user.uid}`,{}).then(()=>{const r=e.parents(".chat-modal");r.length?y.close(r):(n.destroyAutoComplete(t),ajaxify.go("chats"))}).catch(p.error)}})})},n.addDeleteHandler=function(t,e){e.on("click",function(){i.confirm({size:"small",title:"[[modules:chat.delete]]",message:"<p>[[modules:chat.delete-prompt]]</p>",callback:function(a){a&&C.del(`/admin/chats/${t}`,{}).then(()=>{const r=e.parents(".chat-modal");r.length?y.close(r):(n.destroyAutoComplete(t),ajaxify.go("chats"))}).catch(p.error)}})})},n.addRenameHandler=function(t,e){e.on("click",async function(){const{roomName:a}=await C.get(`/chats/${t}`),r=await app.parseAndTranslate("modals/rename-room",{name:a}),h=i.dialog({title:"[[modules:chat.rename-room]]",message:r,onEscape:!0,buttons:{save:{label:"[[global:save]]",className:"btn-primary",callback:function(){return C.put(`/chats/${t}`,{name:h.find("#roomName").val()}).then(()=>{h.modal("hide")}).catch(p.error),!1}}}})})},n.addSendHandlers=function(t,e,a){utils.isMobile()||e.off("keypress").on("keypress",function(r){if(r.which===13&&!r.shiftKey)return o.sendMessage(t,e),!1}),a.off("click").on("click",function(){return o.sendMessage(t,e),e.focus(),!1})},n.createAutoComplete=function(t,e,a={}){if(!e.length)return;const r={element:e,strategies:[],options:{style:{"z-index":2e4,flex:0,top:"inherit"},placement:"top",className:`chat-autocomplete-dropdown-${t} dropdown-menu textcomplete-dropdown`,...a}};if($(window).trigger("chat:autocomplete:init",r),r.strategies.length){const h=s.setup(r);return t&&(n.activeAutocomplete[t]=h),h}},n.destroyAutoComplete=function(t){n.activeAutocomplete[t]&&(n.activeAutocomplete[t].destroy(),delete n.activeAutocomplete[t])},n.leave=function(t){const e=t.attr("data-roomid");C.del(`/chats/${e}/users/${app.user.uid}`,{}).then(()=>{parseInt(e,10)===parseInt(ajaxify.data.roomId,10)?ajaxify.go("user/"+ajaxify.data.userslug+"/chats"):t.remove(),n.destroyAutoComplete(e);const a=y.getModal(e);a.length&&y.close(a)}).catch(p.error)},n.switchChat=function(t){t||(t=""),n.destroyAutoComplete(ajaxify.data.roomId),socket.emit("modules.chats.leave",ajaxify.data.roomId);const e="user/"+ajaxify.data.userslug+"/chats/"+t+window.location.search;if(!self.fetch)return ajaxify.go(e);const a=new URL(document.location).searchParams;a.set("switch",1);const r=`${config.relative_path}/api/user/${ajaxify.data.userslug}/chats/${t}?${a.toString()}`;fetch(r,{credentials:"include"}).then(async function(h){if(!h.ok)return console.warn("[search] Received "+h.status);const k=await h.json(),I=await app.parseAndTranslate("partials/chats/message-window",k),H=x.get("chat/main-wrapper");H.html(I),H.attr("data-roomid",t),T=$('[component="chat/nav-wrapper"]'),I.find(".timeago").timeago(),ajaxify.data={...ajaxify.data,...k,roomId:t},ajaxify.updateTitle(ajaxify.data.title),$("body").toggleClass("chat-loaded",!!t),H.find('[data-bs-toggle="tooltip"]').tooltip({trigger:"hover",container:"#content"}),n.setActive(t),n.addEventListeners(),d.fire("action:chat.loaded",$(".chats-full")),o.scrollToBottomAfterImageLoad(H.find('[component="chat/message/content"]')),history.pushState&&history.pushState({url:e},null,window.location.protocol+"//"+window.location.host+config.relative_path+"/"+e)}).catch(function(h){console.warn("[search] "+h.message)})},n.addGlobalEventListeners=function(){$(window).on("mousemove keypress click",function(){S&&ajaxify.data.roomId&&(C.del(`/chats/${ajaxify.data.roomId}/state`,{}),S=!1)})},n.addSocketListeners=function(){socket.on("event:chats.receive",function(t){y.isFromBlockedUser(t.fromUid)||parseInt(t.roomId,10)===parseInt(ajaxify.data.roomId,10)&&(t.self=parseInt(app.user.uid,10)===parseInt(t.fromUid,10)?1:0,S||(S=t.self===0),t.message.self=t.self,t.message.timestamp=Math.min(Date.now(),t.message.timestamp),t.message.timestampISO=utils.toISOString(t.message.timestamp),o.appendChatMessage($('[component="chat/message/content"]'),t.message),n.updateTeaser(t.roomId,{content:utils.stripHTMLTags(utils.decodeHTMLEntities(t.message.content)),user:t.message.fromUser,timestampISO:t.message.timestampISO}))}),socket.on("event:chats.public.unread",function(t){y.isFromBlockedUser(t.fromUid)||y.isLookingAtRoom(t.roomId)||app.user.uid===parseInt(t.fromUid,10)||(n.markChatPageElUnread(t),n.increasePublicRoomUnreadCount(T.find("[data-roomid="+t.roomId+"]")))}),socket.on("event:user_status_change",function(t){app.updateUserStatus($('.chats-list [data-uid="'+t.uid+'"] [component="user/status"]'),t.status)}),o.addSocketListeners(),socket.on("event:chats.roomRename",function(t){const e=x.get("chat/recent/room",t.roomId);if(e.length){const r=e.find('[component="chat/room/title"]');ajaxify.data.roomName=t.newName,r.translateText(t.newName?t.newName:ajaxify.data.usernames)}const a=$(`[component="chat/main-wrapper"][data-roomid="${t.roomId}"] [component="chat/header/title"]`);a.length&&a.html(t.newName?`<i class="fa ${ajaxify.data.icon} text-muted"></i> ${t.newName}`:ajaxify.data.chatWithMessage)}),socket.on("event:chats.mark",({roomId:t,state:e})=>{$(`[component="chat/recent"] [data-roomid="${t}"], [component="chat/list"] [data-roomid="${t}"], [component="chat/public"] [data-roomid="${t}"]`).each((r,h)=>{const k=$(h);y.markChatElUnread(k,e===1),e===0&&n.updatePublicRoomUnreadCount(k,0)})}),socket.on("event:chats.typing",async t=>{t.uid===app.user.uid||y.isFromBlockedUser(t.uid)||y.updateTypingUserList($(`[component="chat/main-wrapper"][data-roomid="${t.roomId}"]`),t)})},n.updateTeaser=async function(t,e){if(!ajaxify.data.template.chats||!app.user.userslug)return;const a=T.find(`[data-roomid="${t}"]`);if(a.length){const r=await app.parseAndTranslate("partials/chats/room-teaser",{teaser:e});a.find('[component="chat/room/teaser"]').html(r[0].outerHTML),a.find(".timeago").timeago()}else{const{rooms:r}=await C.get("/chats",{start:0,perPage:2}),h=r.find(k=>parseInt(k.roomId,10)===parseInt(t,10));if(h){const k=x.get("chat/recent"),I=await app.parseAndTranslate("chats","rooms",{rooms:[h],showBottomHr:!0});k.prepend(I)}}},n.markChatPageElUnread=function(t){if(!ajaxify.data.template.chats)return;const e=T.find("[data-roomid="+t.roomId+"]");y.markChatElUnread(e,!0)},n.increasePublicRoomUnreadCount=function(t){const e=t.find('[component="chat/public/room/unread/count"]'),a=(parseInt(e.attr("data-count"),10)||0)+1;n.updatePublicRoomUnreadCount(t,a)},n.updatePublicRoomUnreadCount=function(t,e){const a=t.find('[component="chat/public/room/unread/count"]'),r=e>50?"50+":e;a.toggleClass("hidden",e<=0).text(r).attr("data-count",e)},n.setActive=function(t){if(T.find("[data-roomid]").removeClass("active"),t){socket.emit("modules.chats.enter",t);const e=T.find(`[data-roomid="${t}"]`);e.addClass("active"),e.hasClass("unread")&&(C.del(`/chats/${t}/state`,{}),e.removeClass("unread")),utils.isMobile()||$('.expanded-chat [component="chat/input"]').focus(),o.updateTextAreaHeight($(`[component="chat/messages"][data-roomid="${t}"]`))}T.attr("data-loaded",t?"1":"0")},n}).apply(j,w),A!==void 0&&(D.exports=A)}),43103:((D,j,m)=>{var w,A;w=[m(29930)],A=(function(x){const E={};return E.init=function(f){const g=f.uploadFormEl;if(g.length&&(g.attr("action",config.relative_path+f.route),f.dragDropAreaEl&&E.handleDragDrop({container:f.dragDropAreaEl,callback:function(v){E.ajaxSubmit({uploadForm:g,upload:v,callback:f.callback})}}),f.pasteEl&&E.handlePaste({container:f.pasteEl,callback:function(v){E.ajaxSubmit({uploadForm:g,upload:v,callback:f.callback})}}),f.uploadBtnEl)){const v=g.find('input[name="files[]"]');f.uploadBtnEl.on("click",function(){return v.trigger("click"),!1}),v.on("change",function(o){const u=(o.target||{}).files||($(this).val()?[{name:$(this).val(),type:utils.fileMimeType($(this).val())}]:null);u&&E.ajaxSubmit({uploadForm:g,upload:{files:u,fileNames:Array.from(u).map(l=>l.name)},callback:f.callback})})}},E.handleDragDrop=function(f){let g=!1;const v=f.container,o=f.container.find(".imagedrop");v.on("dragenter",function(){g||(o.css("top","0px"),o.css("height",v.height()+"px"),o.css("line-height",v.height()+"px"),o.show(),o.on("dragleave",function(){o.hide(),o.off("dragleave")}))}),o.on("drop",function(c){c.preventDefault();const s=c.originalEvent.dataTransfer.files;if(s.length){let i;if(window.FormData){i=new FormData;for(var d=0;d<s.length;++d)i.append("files[]",s[d],s[d].name)}f.callback({files:s,formData:i})}return o.hide(),!1});function u(l){return l.preventDefault(),!1}$(document).off("dragstart").on("dragstart",function(){g=!0}).off("dragend").on("dragend, mouseup",function(){g=!1}),o.on("dragover",u),o.on("dragenter",u)},E.handlePaste=function(f){f.container.on("paste",function(v){const o=(v.clipboardData||v.originalEvent.clipboardData||{}).items,u=[],l=[];let c=null;window.FormData&&(c=new FormData),[].forEach.call(o,function(s){const d=s.getAsFile();if(d){const i=utils.generateUUID()+"-"+d.name;c&&c.append("files[]",d,i),u.push(d),l.push(i)}}),u.length&&f.callback({files:u,fileNames:l,formData:c})})},E.ajaxSubmit=function(f){const g=[...f.upload.files];for(let o=0;o<g.length;++o){const u=g[o].type.match(/image./);if(u&&!app.user.privileges["upload:post:image"]||!u&&!app.user.privileges["upload:post:file"])return x.error("[[error:no-privileges]]");if(!app.user.isAdmin&&g[o].size>parseInt(config.maximumFileSize,10)*1024)return f.uploadForm[0].reset(),x.error("[[error:file-too-big, "+config.maximumFileSize+"]]")}const v=Date.now();f.uploadForm.off("submit").on("submit",function(){return $(this).ajaxSubmit({headers:{"x-csrf-token":config.csrf_token},resetForm:!0,clearForm:!0,formData:f.upload.formData,error:function(o){let u=o.responseJSON&&(o.responseJSON.error||o.responseJSON.status&&o.responseJSON.status.message)||"[[error:parse-error]]";o&&o.status===413&&(u=o.statusText||"Request Entity Too Large"),x.error(u),x.remove(v)},uploadProgress:function(o,u,l,c){x.alert({alert_id:v,message:"[[modules:composer.uploading, "+c+"%]]"})},success:function(o){const u=o.response.images;if(u&&u.length)for(var l=0;l<u.length;++l)u[l].filename=g[l].name,u[l].isImage=/image./.test(g[l].type);f.callback(u)},complete:function(){f.uploadForm[0].reset(),setTimeout(x.remove,100,v)}}),!1}),f.uploadForm.submit()},E}).apply(j,w),A!==void 0&&(D.exports=A)}),53309:((D,j,m)=>{var w,A;w=[m(52473),m(49897),m(29930)],A=(function(x,E,f){const g={};let v=[];g.init=function(s){s=s||{},v.length=0,x.get("chat/search").on("keyup",utils.debounce(u,250));const d=$('[component="chat/search/list"]');d.on("click","[data-uid]",function(){s.onSelect&&s.onSelect(v.find(i=>String(i.uid)===String($(this).attr("data-uid")))),o(d)})};function o(s){x.get("chat/search").val(""),l(s),s.find('[component="chat/search/no-users"]').addClass("hidden"),s.find('[component="chat/search/start-typing"]').removeClass("hidden")}function u(){const s=$('[component="chat/search/list"]'),d=x.get("chat/search").val();if(!d)return o(s);s.find('[component="chat/search/start-typing"]').addClass("hidden"),E.get("/api/users",{query:d,searchBy:"username",paginate:!1}).then(c).catch(f.error)}function l(s){v.length=0,s.find("[data-uid]").remove()}async function c(s){const d=$('[component="chat/search/list"]');if(l(d),s.users=s.users.filter(function(p){return parseInt(p.uid,10)!==parseInt(app.user.uid,10)}),v=s.users,!s.users.length)return d.find('[component="chat/search/no-users"]').removeClass("hidden");d.find('[component="chat/search/no-users"]').addClass("hidden");const i=await app.parseAndTranslate("modals/create-room","searchUsers",{searchUsers:s.users});d.append(i),d.parent().toggleClass("show",!0)}return g}).apply(j,w),A!==void 0&&(D.exports=A)}),58836:((D,j,m)=>{var w,A;w=[m(49897),m(29930),m(17459),m(34405),m(72513)],A=(function(x,E,f,g,v){const o={};o.init=function(s,d){let i;d.on("click",async function(){let p=[];app.user.isAdmin&&({groups:p}=await x.get("/admin/groups"),p.sort((T,t)=>t.system-T.system).map(T=>{const{name:t,displayName:e}=T;return{name:t,displayName:e}}),Array.isArray(ajaxify.data.groups)&&p.forEach(T=>{T.selected=ajaxify.data.groups.includes(T.name)}));const y=await app.parseAndTranslate("modals/manage-room",{groups:p,user:app.user,room:ajaxify.data});i=bootbox.dialog({title:"[[modules:chat.manage-room]]",size:"large",message:y,onEscape:!0}),i.attr("component","chat/manage-modal"),c(s,i),u(s,i),l(s,i);const C=i.find('[component="chat/manage/user/list"]'),b=i.find('[component="chat/manage/user/list/search"]');v.addSearchHandler(s,b,async T=>{b.val()?C.html(await app.parseAndTranslate("partials/chats/manage-room-users",T)):c(s,i)}),v.addInfiniteScrollHandler(s,C,async(T,t)=>{T.append(await app.parseAndTranslate("partials/chats/manage-room-users",t))});const n=i.find('[component="chat/manage/user/add/search"]'),S=i.find(".text-danger");g.user(n,function(T,t){S.text(""),x.post(`/chats/${s}/users`,{uids:[t.item.user.uid]}).then(e=>{c(s,i,e),n.val("")}).catch(e=>{f.translate(e.message,function(a){S.text(a)})})}),i.find('[component="chat/manage/save"]').on("click",()=>{const T=i.find('[component="chat/room/notification/setting"]'),t=i.find('[component="chat/room/join-leave-messages"]');x.put(`/chats/${s}`,{groups:i.find('[component="chat/room/groups"]').val(),notificationSetting:T.val(),joinLeaveMessages:t.is(":checked")?1:0}).then(e=>{ajaxify.data.groups=e.groups,ajaxify.data.notificationSetting=e.notificationSetting,ajaxify.data.joinLeaveMessages=e.joinLeaveMessages;const a=e.notificationOptions[0];$('[component="chat/notification/setting"] [data-icon]').first().attr("data-icon",a.icon),$('[component="chat/notification/setting/sub-label"]').translateText(a.subLabel),a.selected&&$('[component="chat/notification/setting/icon"]').attr("class",`fa ${a.icon}`),i.modal("hide")}).catch(E.error)})})};function u(s,d){d.on("click",'[data-action="kick"]',function(){const i=encodeURIComponent(this.getAttribute("data-uid"));x.del(`/chats/${s}/users/${i}`,{}).then(p=>{c(s,d,p)}).catch(E.error)})}function l(s,d){d.on("click",'[data-action="toggleOwner"]',async function(){const i=String(this.getAttribute("data-uid")),p=d.get(0).querySelector(`[component="chat/manage/user/list"] > [data-uid="${i}"] [component="chat/manage/user/owner/icon"]`),y=!p.classList.contains("hidden");if(!utils.isNumber(i))return E.error("[[error:invalid-uid]]");await x[y?"del":"put"](`/chats/${s}/owners/${i}`),p.classList.toggle("hidden")})}async function c(s,d,i){const p=d.find('[component="chat/manage/user/list"]');if(!i)try{i=await x.get(`/chats/${s}/users`,{})}catch(y){console.error(y),p.find("li").text(await f.translate("[[error:invalid-data]]"))}p.find('[data-bs-toggle="tooltip"]').tooltip("dispose"),p.html(await app.parseAndTranslate("partials/chats/manage-room-users",i)),p.find('[data-bs-toggle="tooltip"]').tooltip()}return o}).apply(j,w),A!==void 0&&(D.exports=A)}),65161:((D,j,m)=>{var w,A;w=[m(52473),m(29930),m(60419)],A=(function(x,E,f){const g={};let v=0,o,u,l,c,s,d;g.init=function(b,n){v=b,u=n.find('[component="chat/message/search/results"]'),l=n.find('[component="chat/message/content"]'),c=n.find('[component="chat/room/search/clear"]'),d=n.find('[component="chat/room/search/container"]'),s=n.find('[component="chat/room/search/toggle"'),o=n.find('[component="chat/room/search"]'),o.on("keyup",utils.debounce(p,250)).on("focus",()=>{o.val()&&p()}),n.find('[component="chat/input"]').on("focus",()=>{u.addClass("hidden"),l.removeClass("hidden")}),c.on("click",i),s.on("click",()=>{d.removeClass("hidden"),s.addClass("hidden"),o.trigger("focus")}),o.on("blur",()=>{o.val()||i()})};function i(){o.val(""),y(),u.addClass("hidden"),c.addClass("hidden"),d.addClass("hidden"),l.removeClass("hidden"),s.removeClass("hidden")}async function p(){const b=o.val();!b||b.length<=2||(c.removeClass("hidden"),socket.emit("modules.chats.searchMessages",{content:b,roomId:v}).then(C).catch(E.error))}function y(){u.children("[data-mid]").remove()}async function C(b){if(y(),!b.messages.length)return u.removeClass("hidden"),l.addClass("hidden"),u.find('[component="chat/message/search/no-results"]').removeClass("hidden");u.find('[component="chat/message/search/no-results"]').addClass("hidden");const n=await app.parseAndTranslate("partials/chats/messages",{messages:b.messages,isAdminOrGlobalMod:app.user.isAdmin||app.user.isGlobalMod});u.append(n),f.onMessagesAddedToDom(u.find('[component="chat/message"]')),l.addClass("hidden"),u.removeClass("hidden")}return g}).apply(j,w),A!==void 0&&(D.exports=A)}),72513:((D,j,m)=>{var w,A;w=[m(49897)],A=(function(x){const E={};let f=0;E.init=function(u,l){const c=l.find('[component="chat/user/list"]');if(!c.length)return;const s=l.find('[component="chat/messages/pinned/container"]');l.find('[component="chat/user/list/btn"]').on("click",()=>{c.toggleClass("hidden"),c.hasClass("hidden")?v():(s.addClass("hidden"),g(u,c))}),$(window).off("action:ajaxify.start",v).one("action:ajaxify.start",v),E.addInfiniteScrollHandler(u,c,async(d,i)=>{d.append(await app.parseAndTranslate("partials/chats/user-list","users",i))})};function g(u,l){f&&clearInterval(f),f=setInterval(()=>{o(u,l)},5e3)}function v(){f&&(clearInterval(f),f=0)}async function o(u,l){if(ajaxify.data.template.chats&&app.isFocused&&l.scrollTop()===0&&!l.hasClass("hidden")){const c=await x.get(`/chats/${u}/users`,{start:0});l.find('[data-bs-toggle="tooltip"]').tooltip("dispose"),l.html(await app.parseAndTranslate("partials/chats/user-list","users",c)),l.find('[data-bs-toggle="tooltip"]').tooltip()}}return E.addInfiniteScrollHandler=function(u,l,c){l.on("scroll",utils.debounce(async()=>{const s=(l[0].scrollHeight-l.height())*.85;if(l.scrollTop()>s){const d=l.find("[data-index]").last().attr("data-index"),i=await x.get(`/chats/${u}/users`,{start:parseInt(d,10)+1});i&&i.users.length&&c(l,i)}},200))},E.addSearchHandler=function(u,l,c){l.on("keyup",utils.debounce(async()=>{const s=l.val(),d=await x.get(`/search/chats/${u}/users`,{query:s});c(d)},200))},E}).apply(j,w),A!==void 0&&(D.exports=A)}),80083:((D,j,m)=>{var w,A;w=[m(52473),m(49897),m(29930),m(53309)],A=(function(x,E,f,g){const v={};v.init=function(){x.get("chat/create").on("click",o)};async function o(){let u=[];app.user.isAdmin&&({groups:u}=await E.get("/admin/groups"),u.sort((d,i)=>i.system-d.system).map(d=>{const{name:i,displayName:p}=d;return{name:i,displayName:p}}));const l=await app.parseAndTranslate("modals/create-room",{user:app.user,groups:u}),c=bootbox.dialog({title:"[[modules:chat.create-room]]",message:l,onEscape:!0,buttons:{save:{label:"[[global:create]]",className:"btn-primary",callback:function(){const d=c.find('[component="chat/room/name"]').val(),i=c.find('[component="chat/room/users"] [component="chat/user"]').find("[data-uid]").map((C,b)=>$(b).attr("data-uid")).get(),p=c.find('[component="chat/room/type"]').val(),y=c.find('[component="chat/room/groups"]').val();return p==="private"&&!i.length?(f.error("[[error:no-users-selected]]"),!1):p==="public"&&!y.length?(f.error("[[error:no-groups-selected]]"),!1):app.user.uid?(E.post("/chats",{roomName:d,uids:i,type:p,groups:y}).then(({roomId:C})=>{ajaxify.go("chats/"+C),c.modal("hide")}).catch(f.error),!1):(f.error("[[error:not-logged-in]]"),!1)}}}}),s=c.find('[component="chat/room/users"]');g.init({onSelect:async function(d){const i=await app.parseAndTranslate("modals/create-room","selectedUsers",{selectedUsers:[d]});s.append(i)}}),s.on("click",'[component="chat/room/users/remove"]',function(){$(this).parents("[data-uid]").remove()}),c.find('[component="chat/room/type"]').on("change",function(){const d=$(this).val();c.find('[component="chat/room/public/options"]').toggleClass("hidden",d==="private")})}return v}).apply(j,w),A!==void 0&&(D.exports=A)}),93230:((D,j,m)=>{var w,A;w=[m(49897),m(29930)],A=(function(x,E){const f={};let g;f.init=function(l){g=l,$('[component="chat/pinned/messages/btn"]').on("click",async()=>{const c=g.find('[component="chat/messages/pinned/container"]');if(!c.hasClass("hidden"))return c.addClass("hidden");g.find('[component="chat/user/list"]').addClass("hidden"),await f.refreshList(),c.removeClass("hidden")}),v(g)};function v(l){const c=l.find('[component="chat/messages/pinned"]');c.on("scroll",utils.debounce(async()=>{const s=(c[0].scrollHeight-c.height())*.85;if(c.scrollTop()>s){const d=c.find("[data-index]").last().attr("data-index"),i=await u(parseInt(d,10)+1);if(i&&i.length){const p=await o(i);l.find('[component="chat/messages/pinned"]').append(p)}}},200))}f.refreshList=async function(){const l=await u(0);if(!l.length){g.find('[component="chat/messages/pinned/empty"]').removeClass("hidden"),g.find('[component="chat/messages/pinned"]').html("");return}g.find('[component="chat/messages/pinned/empty"]').addClass("hidden");const c=await o(l);g.find('[component="chat/messages/pinned"]').html(c),c.find(".timeago").timeago()};async function o(l){return await app.parseAndTranslate("partials/chats/pinned-messages-list","messages",{isOwner:ajaxify.data.isOwner,isAdminOrGlobalMod:ajaxify.data.isAdminOrGlobalMod,messages:l})}async function u(l){const{messages:c}=await x.get(`/chats/${ajaxify.data.roomId}/messages/pinned`,{start:l});return c}return f.pin=function(l,c){x.put(`/chats/${c}/messages/${l}/pin`,{}).then(()=>{$(`[component="chat/message"][data-mid="${l}"]`).toggleClass("pinned",!0),f.refreshList()}).catch(E.error)},f.unpin=function(l,c){x.del(`/chats/${c}/messages/${l}/pin`,{}).then(()=>{$(`[component="chat/message"][data-mid="${l}"]`).toggleClass("pinned",!1),g.find(`[component="chat/messages/pinned"] [data-mid="${l}"]`).remove(),g.find('[component="chat/messages/pinned"] [data-mid]').length||g.find('[component="chat/messages/pinned/empty"]').removeClass("hidden")}).catch(E.error)},f}).apply(j,w),A!==void 0&&(D.exports=A)})}]);
